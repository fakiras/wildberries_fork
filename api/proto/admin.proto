syntax = "proto3";

package wildberries.admin.v1;

import "common.proto";

option go_package = "wildberries/api/proto/admin/v1;adminv1";

// --- Promotion Admin ---
// POST /admin/promotions
message CreatePromotionRequest {
  string name = 1;
  string description = 2;
  string theme = 3;
  string date_from = 4;  // RFC3339
  string date_to = 5;
  string identification_mode = 6;  // questions | user_profile
  string pricing_model = 7;        // auction | fixed
  int32 slot_count = 8;
  int32 min_discount = 9;
  int32 max_discount = 10;
  repeated string stop_factors = 11;
}

message CreatePromotionResponse {
  int64 id = 1;
  string status = 2;  // NOT_READY
}

// GET /admin/promotions/{id}
message GetPromotionRequest {
  int64 id = 1;
}

message GetPromotionResponse {
  int64 id = 1;
  string name = 2;
  string description = 3;
  string theme = 4;
  string status = 5;
  string date_from = 6;
  string date_to = 7;
  string identification_mode = 8;
  string pricing_model = 9;
  int32 slot_count = 10;
  int32 min_discount = 11;
  int32 max_discount = 12;
  repeated string stop_factors = 13;
  repeated SegmentWithOrder segments = 14;
  map<int32, int64> fixed_prices = 15;  // position -> price
  PromotionPoll poll = 16;
}

message SegmentWithOrder {
  int64 id = 1;
  string name = 2;
  string category_name = 3;
  int32 order_index = 4;
}

message PromotionPoll {
  repeated PollQuestionAdmin questions = 1;
  repeated AnswerTreeNode answer_tree = 2;
}

message PollQuestionAdmin {
  int64 id = 1;
  string text = 2;
  repeated PollOptionAdmin options = 3;
}

message PollOptionAdmin {
  int64 id = 1;
  string text = 2;
  string value = 3;
}

message AnswerTreeNode {
  string node_id = 1;       // UUID
  string parent_node_id = 2;
  string label = 3;
  string value = 4;
}

// PATCH /admin/promotions/{id}
message UpdatePromotionRequest {
  int64 id = 1;
  optional string name = 2;
  optional string description = 3;
  optional string theme = 4;
  optional string date_from = 5;
  optional string date_to = 6;
  optional string identification_mode = 7;
  optional string pricing_model = 8;
  optional int32 slot_count = 9;
  optional int32 min_discount = 10;
  optional int32 max_discount = 11;
  repeated string stop_factors = 12;
}

message UpdatePromotionResponse {}

// DELETE /admin/promotions/{id}
message DeletePromotionRequest {
  int64 id = 1;
}

message DeletePromotionResponse {}

// PUT /admin/promotions/{id}/fixed-prices
message SetFixedPricesRequest {
  int64 promotion_id = 1;
  repeated FixedPriceEntry prices = 2;
}

message FixedPriceEntry {
  int32 position = 1;
  int64 price = 2;
}

message SetFixedPricesResponse {}

// PUT /admin/promotions/{id}/status
message ChangeStatusRequest {
  int64 promotion_id = 1;
  string status = 2;  // NOT_READY | READY_TO_START | RUNNING | PAUSED | COMPLETED
}

message ChangeStatusResponse {}

// POST /horoscope/products — ручная установка товара в слот
message SetSlotProductRequest {
  int64 segment_id = 1;
  int64 slot_id = 2;   // optional, если не указан — выбрать свободный
  int64 product_id = 3;
}

message SetSlotProductResponse {}

// --- Segment Admin ---
// POST /admin/promotions/{id}/segments/generate
message GenerateSegmentsRequest {
  int64 promotion_id = 1;
  bool use_theme = 2;
  int32 limit = 3;
}

message GenerateSegmentsResponse {
  repeated wildberries.common.v1.Segment segments = 1;
}

// POST /admin/promotions/{id}/segments
message CreateSegmentRequest {
  int64 promotion_id = 1;
  string name = 2;
  string category_name = 3;
  int32 order_index = 4;
}

message CreateSegmentResponse {
  int64 id = 1;
  string name = 2;
  string category_name = 3;
}

// PATCH /admin/promotions/{id}/segments/{segmentId}
message UpdateSegmentRequest {
  int64 promotion_id = 1;
  int64 segment_id = 2;
  optional string name = 3;
  optional string category_name = 4;
  optional int32 order_index = 5;
}

message UpdateSegmentResponse {}

// DELETE /admin/promotions/{id}/segments/{segmentId}
message DeleteSegmentRequest {
  int64 promotion_id = 1;
  int64 segment_id = 2;
}

message DeleteSegmentResponse {}

// POST /admin/promotions/{id}/segments/shuffle-categories
message ShuffleSegmentCategoriesRequest {
  int64 promotion_id = 1;
}

message ShuffleSegmentCategoriesResponse {}

// --- Poll Admin ---
// POST /admin/promotions/{id}/poll/generate
message GeneratePollRequest {
  int64 promotion_id = 1;
  string type = 2;  // "questions" | "answer_tree"
}

message GeneratePollResponse {
  repeated PollQuestionAdmin questions = 1;
  repeated AnswerTreeNode answer_tree = 2;
}

// POST /admin/promotions/{id}/poll/questions
message SetPollQuestionsRequest {
  int64 promotion_id = 1;
  repeated SetQuestionInput questions = 2;
}

message SetQuestionInput {
  string text = 1;
  repeated SetOptionInput options = 2;
}

message SetOptionInput {
  string text = 1;
  string value = 2;
}

message SetPollQuestionsResponse {}

// POST /admin/promotions/{id}/poll/answer-tree
message SetAnswerTreeRequest {
  int64 promotion_id = 1;
  repeated AnswerTreeNode nodes = 2;
}

message SetAnswerTreeResponse {}

// --- Moderation ---
// GET /admin/promotions/{id}/moderation/applications
message GetModerationApplicationsRequest {
  int64 promotion_id = 1;
  string status = 2;  // optional: pending | approved | rejected
}

message ModerationApplication {
  int64 id = 1;
  int64 seller_id = 2;
  int64 segment_id = 3;
  int64 slot_id = 4;
  string product_name = 5;
  int64 price = 6;
  int32 discount = 7;
  repeated string stop_factors = 8;
  string status = 9;
}

message GetModerationApplicationsResponse {
  repeated ModerationApplication applications = 1;
}

// POST /admin/moderation/{applicationId}/approve
message ApproveModerationRequest {
  int64 application_id = 1;
}

message ApproveModerationResponse {}

// POST /admin/moderation/{applicationId}/reject
message RejectModerationRequest {
  int64 application_id = 1;
  string reason = 2;
}

message RejectModerationResponse {}

// --- Admin Services ---
service PromotionAdminService {
  rpc CreatePromotion(CreatePromotionRequest) returns (CreatePromotionResponse);
  rpc GetPromotion(GetPromotionRequest) returns (GetPromotionResponse);
  rpc UpdatePromotion(UpdatePromotionRequest) returns (UpdatePromotionResponse);
  rpc DeletePromotion(DeletePromotionRequest) returns (DeletePromotionResponse);
  rpc SetFixedPrices(SetFixedPricesRequest) returns (SetFixedPricesResponse);
  rpc ChangeStatus(ChangeStatusRequest) returns (ChangeStatusResponse);
  rpc SetSlotProduct(SetSlotProductRequest) returns (SetSlotProductResponse);
}

service SegmentAdminService {
  rpc GenerateSegments(GenerateSegmentsRequest) returns (GenerateSegmentsResponse);
  rpc CreateSegment(CreateSegmentRequest) returns (CreateSegmentResponse);
  rpc UpdateSegment(UpdateSegmentRequest) returns (UpdateSegmentResponse);
  rpc DeleteSegment(DeleteSegmentRequest) returns (DeleteSegmentResponse);
  rpc ShuffleSegmentCategories(ShuffleSegmentCategoriesRequest) returns (ShuffleSegmentCategoriesResponse);
}

service PollAdminService {
  rpc GeneratePoll(GeneratePollRequest) returns (GeneratePollResponse);
  rpc SetPollQuestions(SetPollQuestionsRequest) returns (SetPollQuestionsResponse);
  rpc SetAnswerTree(SetAnswerTreeRequest) returns (SetAnswerTreeResponse);
}

service ModerationService {
  rpc GetApplications(GetModerationApplicationsRequest) returns (GetModerationApplicationsResponse);
  rpc Approve(ApproveModerationRequest) returns (ApproveModerationResponse);
  rpc Reject(RejectModerationRequest) returns (RejectModerationResponse);
}
