syntax = "proto3";

package wildberries.buyer;


option go_package = "wildberries/pkg/buyer;buyer";

import "google/protobuf/timestamp.proto";
import "common.proto";
import "google/api/annotations.proto";
import "validate/validate.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "Buyer сервис";
    version: "1.0.0";
    description: "Сервис покупателя для работы с акциями";
  };
  host: "localhost:7001";
  schemes: HTTP;
  consumes: "application/json";
  produces: "application/json";
};

// --- Buyer: текущая акция ---
// GET /promotions/current
message GetCurrentPromotionRequest {}

message GetCurrentPromotionResponse {
  int64 id = 1;
  string name = 2;
  string description = 3;
  string theme = 4;
  string status = 5;  // RUNNING
  string date_from = 6;  // RFC3339
  string date_to = 7;
  repeated wildberries.common.Segment segments = 8;
}

// --- Buyer: продукты сегмента ---
// GET /promotions/{promotionId}/segments/{segmentId}/products
message GetSegmentProductsRequest {
  int64 promotion_id = 1;
  int64 segment_id = 2;
  string category = 3;       // filter
  bool only_discounts = 4;     // filter
  string sort = 5;            // e.g. price_asc, discount_desc
  int32 page = 6;
  int32 per_page = 7;
}

message GetSegmentProductsResponse {
  repeated wildberries.common.ProductItem items = 1;
  int32 total = 2;
  int32 page = 3;
  int32 per_page = 4;
  bool completed = 5;  // акция завершена
}

// --- Identification ---
// POST /identification/start
message StartIdentificationRequest {
  int64 promotion_id = 1;
}

message PollQuestion {
  int64 id = 1;
  string text = 2;
  repeated PollOption options = 3;
}

message PollOption {
  int64 id = 1;
  string text = 2;
  string value = 3;
}

message StartIdentificationResponse {
  string method = 1;  // "questions" | "user_profile"
  oneof poll_or_segment {
    Poll poll = 2;           // для method=questions
    int64 result_segment_id = 3;  // для method=user_profile (заглушка — случайный)
  }
}

message Poll {
  repeated PollQuestion questions = 1;
}

// POST /identification/answer
message AnswerRequest {
  int64 promotion_id = 1;
  int64 question_id = 2;
  int64 option_id = 3;
}

message AnswerResponse {
  int64 next_question_id = 1;   // 0 если нет следующего
  int64 result_segment_id = 2;   // 0 если ещё не финал
}

// --- Buyer API Service ---
service BuyerPromotionService {
  rpc GetCurrentPromotion(GetCurrentPromotionRequest) returns (GetCurrentPromotionResponse) {
    option (google.api.http) = {
      get: "/promotions/current"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Получить текущую акцию";
      description: "Получает информацию о текущей акции";
      tags: "Promotions";
      operation_id: "GetCurrentPromotion";
    };
  }
  rpc GetSegmentProducts(GetSegmentProductsRequest) returns (GetSegmentProductsResponse) {
    option (google.api.http) = {
      get: "/promotions/{promotion_id}/segments/{segment_id}/products"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Получить продукты сегмента";
      description: "Получает список продуктов для заданного сегмента";
      tags: "Products";
      operation_id: "GetSegmentProducts";
    };
  }
}

service IdentificationService {
  rpc StartIdentification(StartIdentificationRequest) returns (StartIdentificationResponse) {
    option (google.api.http) = {
      post: "/identification/start"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Начать идентификацию";
      description: "Начинает процесс идентификации покупателя";
      tags: "Identification";
      operation_id: "StartIdentification";
    };
  }
  rpc Answer(AnswerRequest) returns (AnswerResponse) {
    option (google.api.http) = {
      post: "/identification/answer"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Ответить на вопрос";
      description: "Отвечает на вопрос опроса";
      tags: "Identification";
      operation_id: "Answer";
    };
  }
}